<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#000101">
  <title>WEARC VE Team | VE Session Staffing</title>
  <meta name="description" content="Upcoming WEARC VE sessions with VE attendance and participating call signs." />

  <link rel="icon" href="https://hamradioonlinetest.com/favicon.ico">
  <link rel="apple-touch-icon" href="https://hamradioonlinetest.com/assets/img/icon-192.png">
  <link rel="manifest" href="https://hamradioonlinetest.com/site.webmanifest">

  <link rel="preload" href="https://hamradioonlinetest.com/assets/css/styles.css" as="style">
  <link rel="stylesheet" href="https://hamradioonlinetest.com/assets/css/styles.css">

  <style>
    .hero { padding: 34px 0 18px; }
    .hero-grid { grid-template-columns: 1fr; }
    .lede { font-size: 16px; }

    .tablewrap { overflow:auto; border-radius: 14px; }
    table.sessions {
      width: 100%;
      border-collapse: collapse;
      min-width: 760px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    table.sessions thead th {
      position: sticky;
      top: 0;
      background: #ffffff;
      z-index: 1;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      color: var(--accent2);
      text-align: left;
      padding: 12px 12px;
      white-space: nowrap;
    }
    table.sessions tbody td {
      border-bottom: 1px solid var(--border);
      padding: 12px 12px;
      color: var(--text);
      white-space: nowrap;
      vertical-align: middle;
    }
    table.sessions tbody tr:nth-child(even) td { background: #fafbfc; }

    th.center, td.center { text-align: center; }
    td.center { white-space: nowrap; }

    .sortbtn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }
    .sortind {
      font-size: 12px;
      color: var(--accent);
      min-width: 12px;
      display: inline-block;
    }

    /* Attendance pill (no custom hover tooltip; we keep native title tooltip only) */
    .vepill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(130,69,69,0.25);
      background: rgba(130,69,69,0.08);
      color: var(--accent2);
      font-weight: 900;
      font-size: 13px;
      cursor: pointer;
      position: relative;
      line-height: 1;
    }
    .vepill:focus { outline: 2px solid rgba(130,69,69,0.35); outline-offset: 2px; }

    /* Click popover (mobile + accessible) */
    .popover {
      display: none;
      margin-top: 8px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #ffffff;
      color: var(--text);
      box-shadow: var(--shadow);
    }
    .popover .kicker { margin-bottom: 6px; }
    .popover .calls { color: var(--muted); font-size: 13px; }
    .popover.open { display: block; }

    .toolbar {
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 14px;
    }
    .toolbar .left, .toolbar .right {
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .meta { font-size: 13px; color: rgba(90, 103, 111, 0.9); }

    .toggle {
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--accent2);
      font-weight: 700;
      font-size: 13px;
    }
    .toggle input { transform: scale(1.05); accent-color: var(--accent); }

    .error { color: #8b2f2f; font-weight: 700; }
    .empty { color: var(--muted); padding: 10px 0; }

    /* Allow popover to escape layout if needed */
    .card.pad { overflow: visible; padding-bottom: 30px; }

    /* Mobile vertical optimization */
    @media (max-width: 720px) {
      table.sessions { min-width: unset; border-radius: 14px; }
      table.sessions thead { display: none; }
      table.sessions tbody, table.sessions tr, table.sessions td { display: block; width: 100%; }
      table.sessions tbody tr {
        border-bottom: 1px solid var(--border);
        padding: 10px 12px;
        background: #fff;
      }
      table.sessions tbody tr:nth-child(even) td { background: transparent; }
      table.sessions tbody td {
        border: none;
        padding: 8px 0;
        white-space: normal;
      }
      table.sessions tbody td::before {
        content: attr(data-label);
        display: block;
        font-size: 12px;
        font-weight: 900;
        letter-spacing: 0.2px;
        text-transform: uppercase;
        color: var(--accent2);
        margin-bottom: 2px;
      }
      th.center, td.center { text-align: left; }
      .popover.open { display: block; }
    }
  </style>
</head>

<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <header class="header">
    <div class="container">
      <div class="nav">
        <a class="brand" href="https://hamradioonlinetest.com/">
          <img src="https://hamradioonlinetest.com/assets/img/wearc-logo.png" alt="WEARC logo">
          <div>
            <div style="font-weight:900; letter-spacing:0.2px;">West Essex Amateur Radio Club</div>
            <div class="tag">Online VE exam sessions and new ham support</div>
          </div>
        </a>
        <nav class="navlinks" aria-label="Site">
          <a href="https://hamradioonlinetest.com/get-licensed/">Get Licensed</a>
          <a href="https://hamradioonlinetest.com/new-ham-starter-kit/">Build Your Station</a>
          <a href="https://hamradioonlinetest.com/community/">Community</a>
          <a href="https://www.wearc.org/" rel="noopener">WEARC Club</a>
          <a class="cta" href="https://hamstudy.org/sessions/WEARC/all" rel="noopener">Find a session</a>
        </nav>
      </div>
    </div>
  </header>

  <main id="main">
    <section class="hero">
      <div class="container">
        <div class="hero-grid">
          <div class="card pad">
            <div class="kicker">VE staffing</div>
            <h1 class="h1">Upcoming VE Sessions</h1>
            <p class="lede">
              Click any column header to sort. Hover (desktop) or tap (mobile) the VEs Attending number to see participating call signs.
            </p>

            <div class="toolbar" aria-label="Controls">
              <div class="left">
                <button class="cta secondary" id="refreshBtn" type="button">Refresh</button>

                <label class="toggle" title="Show past dates too (normally hidden)">
                  <input type="checkbox" id="showPast">
                  Show past sessions
                </label>

                <span class="badge" id="sortBadge">Sort: Exam Date (asc)</span>
              </div>

              <div class="right">
                <span class="meta" id="statusText">Loading…</span>
              </div>
            </div>

            <hr class="sep">

            <div class="tablewrap">
              <table class="sessions" aria-label="VE sessions table">
                <thead>
                  <tr>
                    <th data-col="0">
                      <span class="sortbtn">Exam Date <span class="sortind" id="ind0"></span></span>
                    </th>
                    <th data-col="1">
                      <span class="sortbtn">Exam Time <span class="sortind" id="ind1"></span></span>
                    </th>
                    <th data-col="2">
                      <span class="sortbtn">Exam Level <span class="sortind" id="ind2"></span></span>
                    </th>
                    <th data-col="3" class="center">
                      <span class="sortbtn">VEs Attending <span class="sortind" id="ind3"></span></span>
                    </th>
                  </tr>
                </thead>
                <tbody id="tbody">
                  <tr><td colspan="4" class="empty">Loading…</td></tr>
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="card pad">
        <div class="cols">
          <div>
            <div class="kicker">Contact</div>
            <p class="notice">Email: <a href="mailto:hamradiotest@osi3.net">hamradiotest@osi3.net</a><br>
            Call or text: <a href="tel:+1-917-502-2203">+1-917-502-2203</a></p>
            <p class="notice">If you plan to take multiple exam elements in one session, email us ahead of time so we can schedule enough time.</p>
          </div>
          <div>
            <div class="kicker">Register</div>
            <p class="notice">Browse dates and register through HamStudy:</p>
            <p><a class="cta" href="https://hamstudy.org/sessions/WEARC/all" rel="noopener">hamstudy.org/sessions/WEARC/all</a></p>
          </div>
          <div>
            <div class="kicker">About WEARC</div>
            <p class="notice">WEARC (W2EF) is based in Essex County, New Jersey. Visitors are welcome at our weekly Zoom club meetings and community nets.</p>
          </div>
        </div>
        <hr class="sep">
        <small>© <span data-year></span> West Essex Amateur Radio Club.</small>
      </div>
    </div>
  </footer>

  <script src="https://hamradioonlinetest.com/assets/js/main.js" defer></script>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaE9-FvqbIvds_pm4EJ19rCXH-h5-cJy6wQZS14oEgwsTbp2vg-g7QjK9IcataI9D6J2nbJgbGTKj9/pub?gid=1540923019&single=true&output=csv";

    const tbody = document.getElementById("tbody");
    const statusText = document.getElementById("statusText");
    const refreshBtn = document.getElementById("refreshBtn");
    const showPast = document.getElementById("showPast");
    const sortBadge = document.getElementById("sortBadge");

    const indicators = [
      document.getElementById("ind0"),
      document.getElementById("ind1"),
      document.getElementById("ind2"),
      document.getElementById("ind3")
    ];

    let sortCol = 0;
    let sortDir = "asc";
    let allRows = [];

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function parseCSV(text) {
      const rows = [];
      let cur = "", inQ = false, row = [];
      for (let i = 0; i < text.length; i++) {
        const ch = text[i], next = text[i + 1];
        if (ch === '"' && inQ && next === '"') { cur += '"'; i++; continue; }
        if (ch === '"') { inQ = !inQ; continue; }
        if (ch === "," && !inQ) { row.push(cur); cur = ""; continue; }
        if ((ch === "\n" || ch === "\r") && !inQ) {
          if (cur.length || row.length) { row.push(cur); rows.push(row); }
          cur = ""; row = [];
          if (ch === "\r" && next === "\n") i++;
          continue;
        }
        cur += ch;
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }
      return rows;
    }

    function todayLocalMidnight(){
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
    }

    function parseDateLoose(s){
      const t = (s || "").trim();
      if (!t) return null;

      let m = t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]), 0, 0, 0, 0);

      m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m) return new Date(Number(m[3]), Number(m[1]) - 1, Number(m[2]), 0, 0, 0, 0);

      const d = new Date(t);
      if (!Number.isNaN(d.getTime())) {
        return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);
      }
      return null;
    }

    function normalizeTimeKey(s){
      const t = (s || "").trim();
      const m = t.match(/^(\d{1,2}):(\d{2})(?:\s*([AaPp][Mm]))?$/);
      if (!m) return t.toLowerCase();
      let hh = Number(m[1]);
      const mm = Number(m[2]);
      const ap = (m[3]||"").toUpperCase();
      if (ap === "PM" && hh < 12) hh += 12;
      if (ap === "AM" && hh === 12) hh = 0;
      return String(hh).padStart(2,"0") + ":" + String(mm).padStart(2,"0");
    }

    function toNum(v){
      const n = Number(String(v ?? "").trim());
      return Number.isFinite(n) ? n : 0;
    }

    function cleanCallList(s){
      const raw = (s || "").trim();
      if (!raw) return [];
      return raw.split(",").map(x => x.trim().toUpperCase()).filter(Boolean);
    }

    function updateSortUI(){
      indicators.forEach((el, idx) => {
        el.textContent = (idx === sortCol) ? (sortDir === "asc" ? "▲" : "▼") : "";
      });
      const names = ["Exam Date", "Exam Time", "Exam Level", "VEs Attending"];
      sortBadge.textContent = `Sort: ${names[sortCol]} (${sortDir})`;
    }

    function rowCompare(a, b){
      let cmp = 0;

      if (sortCol === 0) {
        const at = a.dateObj ? a.dateObj.getTime() : 0;
        const bt = b.dateObj ? b.dateObj.getTime() : 0;
        cmp = at - bt;
        if (cmp === 0) cmp = a.sortTimeKey.localeCompare(b.sortTimeKey);
      } else if (sortCol === 1) {
        cmp = a.sortTimeKey.localeCompare(b.sortTimeKey);
        if (cmp === 0) {
          const at = a.dateObj ? a.dateObj.getTime() : 0;
          const bt = b.dateObj ? b.dateObj.getTime() : 0;
          cmp = at - bt;
        }
      } else if (sortCol === 2) {
        cmp = a.levelStr.localeCompare(b.levelStr);
        if (cmp === 0) {
          const at = a.dateObj ? a.dateObj.getTime() : 0;
          const bt = b.dateObj ? b.dateObj.getTime() : 0;
          cmp = at - bt;
        }
      } else if (sortCol === 3) {
        cmp = a.attendingNum - b.attendingNum;
        if (cmp === 0) {
          const at = a.dateObj ? a.dateObj.getTime() : 0;
          const bt = b.dateObj ? b.dateObj.getTime() : 0;
          cmp = at - bt;
        }
      }

      return sortDir === "asc" ? cmp : -cmp;
    }

    function closeAllPopovers(){
      document.querySelectorAll(".popover.open").forEach(p => p.classList.remove("open"));
      document.querySelectorAll(".vepill[aria-expanded='true']").forEach(b => b.setAttribute("aria-expanded","false"));
    }

    function wirePopovers(){
      document.querySelectorAll(".vepill").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = btn.getAttribute("data-pop");
          const pop = document.getElementById(id);
          if (!pop) return;

          const isOpen = pop.classList.contains("open");
          closeAllPopovers();
          if (!isOpen) {
            pop.classList.add("open");
            btn.setAttribute("aria-expanded","true");
          }
          e.stopPropagation();
        });
      });
    }

    function render(){
      updateSortUI();

      const cutoff = todayLocalMidnight();
      const includePast = showPast.checked;

      const filtered = allRows.filter(r => {
        if (!r.dateObj) return false;
        if (includePast) return true;
        return r.dateObj.getTime() >= cutoff.getTime();
      });

      filtered.sort(rowCompare);

      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="empty">No upcoming sessions found.</td></tr>`;
        return;
      }

      tbody.innerHTML = filtered.map((r, idx) => {
        const tooltip = r.calls.length ? r.calls.join(", ") : "No VEs listed";
        const popId = `pop-${idx}`;

        return `
          <tr>
            <td data-label="Exam Date">${esc(r.dateStr)}</td>
            <td data-label="Exam Time">${esc(r.timeStr)}</td>
            <td data-label="Exam Level">${esc(r.levelStr)}</td>
            <td data-label="VEs Attending" class="center">
              <button
                type="button"
                class="vepill"
                data-pop="${popId}"
                aria-expanded="false"
                aria-controls="${popId}"
                title="${esc(tooltip)}"
              >${esc(String(r.attendingNum))}</button>

              <div class="popover" id="${popId}" role="dialog" aria-label="Participating VEs">
                <div class="kicker">Participating VEs</div>
                <div class="calls">${esc(r.calls.length ? r.calls.join(", ") : "No VEs listed")}</div>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      wirePopovers();
    }

    async function load(){
      try{
        statusText.textContent = "Loading…";
        tbody.innerHTML = `<tr><td colspan="4" class="empty">Loading…</td></tr>`;

        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("CSV fetch failed (" + res.status + ")");

        const text = await res.text();
        const rows = parseCSV(text);

        if (rows.length < 2) {
          statusText.textContent = "No sessions returned";
          tbody.innerHTML = `<tr><td colspan="4" class="empty">No sessions found.</td></tr>`;
          return;
        }

        // Expect 5 columns:
        // 0 Exam Date, 1 Exam Time, 2 Exam Level, 3 VEs Attending, 4 VEs Participating
        const data = rows.slice(1).filter(r => (r || []).some(c => String(c||"").trim() !== ""));

        allRows = data.map(r => {
          const dateStr = (r[0] ?? "").toString().trim();
          const timeStr = (r[1] ?? "").toString().trim();
          const levelStr = (r[2] ?? "").toString().trim();
          const attendingStr = (r[3] ?? "0").toString().trim();
          const callsStr = (r[4] ?? "").toString().trim();

          return {
            dateStr,
            timeStr,
            levelStr,
            attendingNum: toNum(attendingStr),
            calls: cleanCallList(callsStr),
            dateObj: parseDateLoose(dateStr),
            sortTimeKey: normalizeTimeKey(timeStr)
          };
        });

        statusText.textContent = "Last loaded: " + new Date().toLocaleString();
        closeAllPopovers();
        render();

        document.addEventListener("click", () => closeAllPopovers());
      } catch (err) {
        statusText.textContent = "Load failed";
        tbody.innerHTML = `<tr><td colspan="4" class="error">${esc(err.message || err)}</td></tr>`;
      }
    }

    document.querySelectorAll("thead th[data-col]").forEach(th => {
      th.addEventListener("click", () => {
        const col = Number(th.getAttribute("data-col"));
        if (col === sortCol) {
          sortDir = (sortDir === "asc") ? "desc" : "asc";
        } else {
          sortCol = col;
          sortDir = "asc";
        }
        closeAllPopovers();
        render();
      });
    });

    refreshBtn.addEventListener("click", load);
    showPast.addEventListener("change", () => {
      closeAllPopovers();
      render();
    });

    load();
  </script>
</body>
</html>
