<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#000101">
  <title>WEARC VE Session Counts</title>

  <link rel="icon" href="https://hamradioonlinetest.com/favicon.ico">
  <link rel="preload" href="https://hamradioonlinetest.com/assets/css/styles.css" as="style">
  <link rel="stylesheet" href="https://hamradioonlinetest.com/assets/css/styles.css">

  <style>
    .counts-toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:12px}
    .muted{opacity:.8}
    .center{text-align:center}
    .mono{font-variant-numeric:tabular-nums}
    .table-wrap{overflow:auto;border-radius:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    th{text-align:left;position:sticky;top:0;z-index:1}
    tr:hover td{background:rgba(255,255,255,.03)}
    .statusline{margin-top:10px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);font-size:.95rem}
    .sortbtn{cursor:pointer;user-select:none;display:inline-flex;align-items:center;gap:6px}
    .sortind{display:inline-block;min-width:1ch;opacity:.95}

    /* Table header styled to match the site's .cta button (eg "Find a session") */
    .thead-cta th{background:var(--cta-bg,#1e8fff);color:var(--cta-fg,#fff);border-bottom:1px solid rgba(255,255,255,.18)}
  </style>
</head>

<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <header class="header">
    <div class="container">
      <div class="nav">
        <a class="brand" href="https://hamradioonlinetest.com/">
          <img src="https://hamradioonlinetest.com/assets/img/wearc-logo.png" alt="WEARC logo">
          <div>
            <div style="font-weight:900; letter-spacing:0.2px;">West Essex Amateur Radio Club</div>
            <div class="tag">Online VE exam sessions and new ham support</div>
          </div>
        </a>
        <nav class="navlinks" aria-label="Site">
          <a href="https://hamradioonlinetest.com/get-licensed/">Get Licensed</a>
          <a href="https://hamradioonlinetest.com/new-ham-starter-kit/">Build Your Station</a>
          <a href="https://hamradioonlinetest.com/community/">Community</a>
          <a href="https://www.wearc.org/" rel="noopener">WEARC Club</a>
          <a class="cta" href="https://hamstudy.org/sessions/WEARC/all" rel="noopener">Find a session</a>
        </nav>
      </div>
    </div>
  </header>

  <main id="main">
    <section class="section">
      <div class="container">
        <div class="card pad">
          <div class="kicker">Counts</div>
          <h1 class="h1" style="margin-top:6px;">WEARC VE Session Counts</h1>

          <div class="counts-toolbar">
            <div class="muted">
              <span class="pill">WEARC VEs: <span id="veCount" class="mono">0</span></span>
              <span class="pill">Total sessions: <span id="totalSessions" class="mono">0</span></span>
            </div>
            <button id="refreshBtn" class="cta secondary" type="button">Refresh</button>
          </div>

          <p id="status" class="notice statusline muted">Loading…</p>

          <div class="table-wrap" style="margin-top:10px;">
            <table aria-describedby="status">
              <thead class="thead-cta">
                <tr>
                  <th data-col="0"><span class="sortbtn">Call Sign <span class="sortind" id="ind0"></span></span></th>
                  <th data-col="1" class="center"><span class="sortbtn">Sessions <span class="sortind" id="ind1"></span></span></th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="2" class="muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>

          <p class="notice muted" style="margin-top:12px;">
            Last fetched: <span id="fetchedAt" class="mono">-</span>
          </p>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="card pad">
        <small>© <span data-year></span> West Essex Amateur Radio Club.</small>
      </div>
    </div>
  </footer>

  <script src="https://hamradioonlinetest.com/assets/js/main.js" defer></script>

  <script>
  (() => {
    "use strict";

    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaE9-FvqbIvds_pm4EJ19rCXH-h5-cJy6wQZS14oEgwsTbp2vg-g7QjK9IcataI9D6J2nbJgbGTKj9/pub?gid=1540923019&single=true&output=csv";
    const WINDOW_MS = 3 * 60 * 60 * 1000;

    const $ = (id) => document.getElementById(id);
    const tbody = $("tbody"), statusEl = $("status"), fetchedAtEl = $("fetchedAt");
    const veCountEl = $("veCount"), totalSessionsEl = $("totalSessions"), refreshBtn = $("refreshBtn");

    let sortCol = 1, sortDir = "desc", rows = [];

    const esc = (s) => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    const setStatus = (m) => (statusEl.textContent = m);

    // Match table header colors to site's .cta button
    const syncCtaColors = () => {
      try{
        const a = document.querySelector("a.cta");
        if(!a) return;
        const cs = getComputedStyle(a);
        if(cs.backgroundColor) document.documentElement.style.setProperty("--cta-bg", cs.backgroundColor);
        if(cs.color) document.documentElement.style.setProperty("--cta-fg", cs.color);
      }catch(_){}
    };

    // CSV parser (quotes + commas + newlines-in-quotes)
    function parseCSV(text){
      const out=[]; let row=[], field="", i=0, q=false;
      while(i<text.length){
        const c=text[i];
        if(q){
          if(c==="\"" && text[i+1]==="\""){ field+="\""; i+=2; continue; }
          if(c==="\""){ q=false; i++; continue; }
          field+=c; i++; continue;
        }
        if(c==="\""){ q=true; i++; continue; }
        if(c===","){ row.push(field); field=""; i++; continue; }
        if(c==="\r"){ i++; continue; }
        if(c==="\n"){ row.push(field); out.push(row); row=[]; field=""; i++; continue; }
        field+=c; i++;
      }
      row.push(field); out.push(row);
      while(out.length && out[out.length-1].every(v=>String(v||"").trim()==="")) out.pop();
      return out;
    }

    const normCall = (raw) => {
      if(!raw) return "";
      let s=String(raw).toUpperCase().trim().replace(/\s+/g,"").replace(/\/{2,}/g,"/").replace(/[^A-Z0-9/]/g,"");
      if(s.includes("/")) s=s.split("/")[0];
      return (s.length>=3 && /[A-Z]/.test(s) && /[0-9]/.test(s)) ? s : "";
    };

    const extractCalls = (cell) => {
      const t=String(cell||"").trim();
      if(!t) return [];
      const parts=t.split(/[,;|]+|\t+|\s{2,}/g);
      const out=[];
      for(const p of parts){
        const bits = p.includes(" ") ? p.split(/\s+/g) : [p];
        for(const b of bits){ const cs=normCall(b); if(cs) out.push(cs); }
      }
      return out;
    };

    // Parse a datetime from a cell. Missing time -> noon. Missing year -> infer.
    function parseDT(raw, todayStart){
      const s0=String(raw||"").trim();
      if(!s0) return null;

      let s=s0.replace(/^(Mon|Tue|Tues|Wed|Thu|Thur|Thurs|Fri|Sat|Sun|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b,?\s*/i,"").trim();

      // ISO YYYY-MM-DD [HH:MM]
      let m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})(?:[ T](\d{1,2}):(\d{2}))?/);
      if(m){
        const y=+m[1], mo=+m[2]-1, d=+m[3], hh=m[4]!=null?+m[4]:12, mm=m[5]!=null?+m[5]:0;
        return new Date(y, mo, d, hh, mm, 0, 0);
      }

      // M/D[/Y] [HH:MM [AM/PM]]
      m=s.match(/^(\d{1,2})[\/-](\d{1,2})(?:[\/-](\d{2}|\d{4}))?(?:\s+(\d{1,2}):(\d{2})(?:\s*([AP]M))?)?/i);
      if(m){
        const mo=+m[1]-1, d=+m[2];
        let y;
        const yearToken = m[3];
        if(!yearToken) y = todayStart.getFullYear();
        else if(yearToken.length===2){ const yy=+yearToken; y = yy>=70 ? 1900+yy : 2000+yy; }
        else y = +yearToken;

        let hh = m[4]!=null ? +m[4] : 12;
        const mm = m[5]!=null ? +m[5] : 0;
        const ap = (m[6]||"").toUpperCase();
        if(ap){ if(hh===12) hh=0; if(ap==="PM") hh+=12; }

        let dt = new Date(y, mo, d, hh, mm, 0, 0);
        if(!yearToken && dt >= todayStart) dt = new Date(todayStart.getFullYear()-1, mo, d, hh, mm, 0, 0);
        return dt;
      }

      // Month names (fallback)
      const parsed = Date.parse(s);
      if(!Number.isNaN(parsed)){
        const d = new Date(parsed);
        if(!/\d{1,2}:\d{2}/.test(s)) d.setHours(12,0,0,0);
        const hasYear = /\b\d{4}\b/.test(s) || /\b\d{2}\b$/.test(s);
        if(!hasYear){
          const dd = new Date(todayStart.getFullYear(), d.getMonth(), d.getDate(), d.getHours(), d.getMinutes(), 0, 0);
          if(dd >= todayStart) dd.setFullYear(dd.getFullYear()-1);
          return dd;
        }
        return d;
      }
      return null;
    }

    const detectCol = (table, scorer) => {
      if(!table || table.length<2) return -1;
      const colCount=Math.max(...table.map(r=>r.length));
      const sample=table.slice(1, Math.min(table.length, 250));
      let best=-1, bestScore=0;
      for(let c=0;c<colCount;c++){
        let score=0;
        for(const r of sample){
          const v=r && r[c]!=null ? r[c] : "";
          if(String(v||"").trim()==="") continue;
          score += scorer(v);
        }
        if(score>bestScore){ bestScore=score; best=c; }
      }
      return bestScore ? best : -1;
    };

    const detectDateCol = (table, todayStart) => {
      const headers=(table[0]||[]).map(v=>String(v||"").trim());
      for(let i=0;i<headers.length;i++){
        if(/\b(exam\s*date|session\s*date|date)\b/i.test(headers[i])) return i;
      }
      return detectCol(table, (v)=> parseDT(v, todayStart) ? 1 : 0);
    };

    const detectCallCol = (table) => detectCol(table, (v)=> extractCalls(v).length);

    const dayKey = (d) => {
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    };

    // Total sessions:
    // - only past sessions (strictly before today)
    // - within a calendar day, events within 3 hours are one session
    // VE sessions credit:
    // - same day + 3-hour clustering, per VE
    function compute(table){
      const counts=new Map();
      if(!table || table.length<2) return { counts, total:0, dateIdx:-1, callIdx:-1, events:0 };

      const now=new Date();
      const todayStart=new Date(now.getFullYear(), now.getMonth(), now.getDate());

      const dateIdx = detectDateCol(table, todayStart);
      const callIdx = detectCallCol(table);
      if(callIdx < 0) return { counts, total:0, dateIdx, callIdx, events:0 };

      const events=[]; // {t(ms), day, calls(Set)}
      for(let r=1;r<table.length;r++){
        const row=table[r];
        if(!row || row.every(c=>String(c||"").trim()==="")) continue;

        let dt = (dateIdx>=0) ? parseDT(row[dateIdx], todayStart) : null;
        if(!dt){
          for(let c=0;c<row.length;c++){ dt = parseDT(row[c], todayStart); if(dt) break; }
        }
        if(!dt) continue;

        // past only
        const d0 = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
        if(d0 >= todayStart) continue;

        const callsArr = extractCalls(row[callIdx] ?? "");
        if(!callsArr.length) continue;

        events.push({ t: dt.getTime(), day: dayKey(dt), calls: new Set(callsArr) });
      }

      // total sessions: cluster per day
      const dayTimes = new Map();
      for(const e of events){
        let a = dayTimes.get(e.day);
        if(!a){ a=[]; dayTimes.set(e.day,a); }
        a.push(e.t);
      }
      let total=0;
      for(const a of dayTimes.values()){
        a.sort((x,y)=>x-y);
        let last=null;
        for(const t of a){ if(last===null || (t-last) > WINDOW_MS) total++; last=t; }
      }

      // VE credit: cluster per VE per day
      const per = new Map(); // call|day -> [t...]
      for(const e of events){
        for(const cs of e.calls){
          const k = cs + "|" + e.day;
          let a = per.get(k);
          if(!a){ a=[]; per.set(k,a); }
          a.push(e.t);
        }
      }
      for(const [k, a] of per.entries()){
        a.sort((x,y)=>x-y);
        let n=0, last=null;
        for(const t of a){ if(last===null || (t-last) > WINDOW_MS) n++; last=t; }
        const call = k.split("|")[0];
        counts.set(call, (counts.get(call)||0) + n);
      }

      return { counts, total, dateIdx, callIdx, events: events.length };
    }

    const updateIndicators = () => {
      $("ind0").textContent=""; $("ind1").textContent="";
      const a = sortDir==="asc" ? "▲" : "▼";
      if(sortCol===0) $("ind0").textContent=a;
      if(sortCol===1) $("ind1").textContent=a;
    };

    const render = () => {
      const sorted = rows.slice().sort((a,b)=>{
        let cmp = sortCol===0 ? a.call.localeCompare(b.call) : (a.sessions-b.sessions);
        if(cmp===0) cmp = a.call.localeCompare(b.call);
        return sortDir==="asc" ? cmp : -cmp;
      });

      veCountEl.textContent = String(sorted.length);
      updateIndicators();

      tbody.innerHTML = sorted.length
        ? sorted.map(r => `<tr><td class="mono">${esc(r.call)}</td><td class="center mono">${esc(r.sessions)}</td></tr>`).join("")
        : "<tr><td colspan=\"2\" class=\"muted\">No data.</td></tr>";
    };

    async function fetchAndBuild(){
      setStatus("Loading…");
      tbody.innerHTML = "<tr><td colspan=\"2\" class=\"muted\">Loading…</td></tr>";
      totalSessionsEl.textContent = "0";
      veCountEl.textContent = "0";

      try{
        const url = CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "cb=" + Date.now();
        const resp = await fetch(url, { cache:"no-store" });
        if(!resp.ok) throw new Error("CSV fetch failed: HTTP " + resp.status);

        const table = parseCSV(await resp.text());
        const { counts, total, dateIdx, callIdx, events } = compute(table);

        totalSessionsEl.textContent = String(total);
        rows = Array.from(counts.entries()).map(([call,sessions]) => ({ call, sessions }));
        sortCol = 1; sortDir = "desc";

        fetchedAtEl.textContent = new Date().toLocaleString([], {
          year:"numeric", month:"2-digit", day:"2-digit",
          hour:"2-digit", minute:"2-digit", second:"2-digit"
        });

        if(callIdx < 0){
          setStatus("Could not locate the VE call sign column in the CSV.");
          rows = [];
          render();
          return;
        }
        if(dateIdx < 0 && events === 0){
          setStatus("Could not locate/parse a session date/time column, so completed sessions could not be determined.");
          rows = [];
          render();
          return;
        }
        if(!rows.length){
          setStatus("No completed sessions found to count.");
          render();
          return;
        }

        setStatus("Loaded.");
        render();
      }catch(e){
        console.error(e);
        setStatus("Could not load counts. Please try again.");
        tbody.innerHTML = "<tr><td colspan=\"2\" class=\"muted\">Error loading data.</td></tr>";
      }
    }

    document.addEventListener("click", (e) => {
      const th = e.target && e.target.closest ? e.target.closest("th[data-col]") : null;
      if(!th) return;
      const col = Number(th.getAttribute("data-col"));
      if(Number.isNaN(col)) return;
      if(sortCol===col) sortDir = (sortDir==="asc") ? "desc" : "asc";
      else { sortCol=col; sortDir = (col===1) ? "desc" : "asc"; }
      render();
    });

    syncCtaColors();
    refreshBtn.addEventListener("click", fetchAndBuild);
    fetchAndBuild();
  })();
  </script>
</body>
</html>
