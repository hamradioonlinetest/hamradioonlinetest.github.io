<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#000101">
  <title>WEARC VE Session Counts</title>
  <meta name="description" content="Counts of completed VE sessions by call sign, based on the live WEARC sessions data feed.">
  <link rel="canonical" href="https://hamradioonlinetest.com/counts/">
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1">

  <meta property="og:type" content="website">
  <meta property="og:site_name" content="WEARC Online Ham Radio Exams">
  <meta property="og:title" content="WEARC VE Session Counts">
  <meta property="og:description" content="Counts of completed VE sessions by call sign, based on the live WEARC sessions data feed.">
  <meta property="og:url" content="https://hamradioonlinetest.com/counts/">
  <meta property="og:image" content="https://hamradioonlinetest.com/assets/img/og.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="WEARC VE Session Counts">
  <meta name="twitter:description" content="Counts of completed VE sessions by call sign, based on the live WEARC sessions data feed.">
  <meta name="twitter:image" content="https://hamradioonlinetest.com/assets/img/og.png">

  <link rel="icon" href="https://hamradioonlinetest.com/favicon.ico">
  <link rel="apple-touch-icon" href="https://hamradioonlinetest.com/assets/img/icon-192.png">
  <link rel="manifest" href="https://hamradioonlinetest.com/site.webmanifest">
  <link rel="preload" href="https://hamradioonlinetest.com/assets/css/styles.css" as="style">
  <link rel="stylesheet" href="https://hamradioonlinetest.com/assets/css/styles.css">

  <style>
    .counts-toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:12px}
    .muted{opacity:.8}
    .center{text-align:center}
    .mono{font-variant-numeric:tabular-nums}
    .stickyhead thead th{position:sticky;top:0;z-index:1;background:rgba(0,0,0,.65);backdrop-filter:blur(6px)}
    .sortbtn{cursor:pointer;user-select:none;display:inline-flex;align-items:center;gap:6px}
    .sortind{display:inline-block;min-width:1ch;opacity:.85}
    .table-wrap{overflow:auto;border-radius:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    th{text-align:left}
    tr:hover td{background:rgba(255,255,255,.03)}
    .statusline{margin-top:10px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);font-size:.95rem}
  </style>
</head>

<body>
  <a class="skip-link" href="#main">Skip to content</a>
  <header class="header">
    <div class="container">
      <div class="nav">
        <a class="brand" href="https://hamradioonlinetest.com/">
          <img src="https://hamradioonlinetest.com/assets/img/wearc-logo.png" alt="WEARC logo">
          <div>
            <div style="font-weight:900; letter-spacing:0.2px;">West Essex Amateur Radio Club</div>
            <div class="tag">Online VE exam sessions and new ham support</div>
          </div>
        </a>
        <nav class="navlinks" aria-label="Site">
          <a href="https://hamradioonlinetest.com/get-licensed/">Get Licensed</a>
          <a href="https://hamradioonlinetest.com/new-ham-starter-kit/">Build Your Station</a>
          <a href="https://hamradioonlinetest.com/community/">Community</a>
          <a href="https://www.wearc.org/" rel="noopener">WEARC Club</a>
          <a class="cta" href="https://hamstudy.org/sessions/WEARC/all" rel="noopener">Find a session</a>
        </nav>
      </div>
    </div>
  </header>

  <main id="main">
    <section class="section">
      <div class="container">
        <div class="card pad">
          <div class="kicker">Counts</div>
          <h1 class="h1" style="margin-top:6px;">WEARC VE Session Counts</h1>

          <div class="counts-toolbar">
            <div class="muted">
              <span class="pill">Operators: <span id="rowCount" class="mono">0</span></span>
              <span class="pill">Completed sessions processed: <span id="sessionCount" class="mono">0</span></span>
            </div>
            <button id="refreshBtn" class="cta secondary" type="button">Refresh</button>
          </div>

          <p id="status" class="notice statusline muted">Loading…</p>

          <div class="table-wrap" style="margin-top:10px;">
            <table class="stickyhead" aria-describedby="status">
              <thead>
                <tr>
                  <th data-col="0"><span class="sortbtn">Call Sign <span class="sortind" id="ind0"></span></span></th>
                  <th data-col="1" class="center"><span class="sortbtn">Sessions <span class="sortind" id="ind1"></span></span></th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="2" class="muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>

          <p class="notice muted" style="margin-top:12px;">
            Last fetched: <span id="fetchedAt" class="mono">-</span>
          </p>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="card pad">
        <div class="cols">
          <div>
            <div class="kicker">Contact</div>
            <p class="notice">Email: <a href="mailto:hamradiotest@osi3.net">hamradiotest@osi3.net</a><br>
            Call or text: <a href="tel:+1-917-502-2203">+1-917-502-2203</a></p>
            <p class="notice">If you plan to take multiple exam elements in one session, email us ahead of time so we can schedule enough time.</p>
          </div>
          <div>
            <div class="kicker">Register</div>
            <p class="notice">Browse dates and register through HamStudy:</p>
            <p><a class="cta" href="https://hamstudy.org/sessions/WEARC/all" rel="noopener">hamstudy.org/sessions/WEARC/all</a></p>
          </div>
          <div>
            <div class="kicker">About WEARC</div>
            <p class="notice">WEARC (W2EF) is based in Essex County, New Jersey. Visitors are welcome at our weekly Zoom club meetings and community nets.</p>
          </div>
        </div>
        <hr class="sep">
        <small>© <span data-year></span> West Essex Amateur Radio Club.</small>
      </div>
    </div>
  </footer>

  <script src="https://hamradioonlinetest.com/assets/js/main.js" defer></script>

  <script>
  (() => {
    "use strict";

    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaE9-FvqbIvds_pm4EJ19rCXH-h5-cJy6wQZS14oEgwsTbp2vg-g7QjK9IcataI9D6J2nbJgbGTKj9/pub?gid=1540923019&single=true&output=csv";

    const $ = (id) => document.getElementById(id);
    const tbody = $("tbody"), statusEl = $("status"), fetchedAtEl = $("fetchedAt");
    const rowCountEl = $("rowCount"), sessionCountEl = $("sessionCount"), refreshBtn = $("refreshBtn");

    let sortCol = 1, sortDir = "desc", rows = [];

    const esc = (s) => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    const setStatus = (m) => (statusEl.textContent = m);

    function parseCSV(text){
      const out=[]; let row=[], field="", i=0, q=false;
      while(i<text.length){
        const c=text[i];
        if(q){
          if(c==="\"" && text[i+1]==="\""){ field+="\""; i+=2; continue; }
          if(c==="\""){ q=false; i++; continue; }
          field+=c; i++; continue;
        }
        if(c==="\""){ q=true; i++; continue; }
        if(c===","){ row.push(field); field=""; i++; continue; }
        if(c==="\r"){ i++; continue; }
        if(c==="\n"){ row.push(field); out.push(row); row=[]; field=""; i++; continue; }
        field+=c; i++;
      }
      row.push(field); out.push(row);
      while(out.length && out[out.length-1].every(v=>String(v||"").trim()==="")) out.pop();
      return out;
    }

    function normCall(raw){
      if(!raw) return "";
      let s=String(raw).toUpperCase().trim().replace(/\s+/g,"").replace(/\/{2,}/g,"/").replace(/[^A-Z0-9/]/g,"");
      if(s.includes("/")) s=s.split("/")[0];
      if(s.length<3 || !/[A-Z]/.test(s) || !/[0-9]/.test(s)) return "";
      return s;
    }

    function extractCalls(cell){
      const t=String(cell||"").trim();
      if(!t) return [];
      const parts=t.split(/[,;|]+|\t+|\s{2,}/g);
      const out=[];
      for(const p of parts){
        const bits = p.includes(" ") ? p.split(/\s+/g) : [p];
        for(const b of bits){ const cs=normCall(b); if(cs) out.push(cs); }
      }
      return out;
    }

    // Flexible date parse:
    // - Accepts "YYYY-MM-DD", "M/D/YYYY", "M/D/YY", "Feb 2 2026", "Feb 2, 2026", with optional weekday/time.
    // - If year is missing (e.g., "Feb 2" or "2/2"), assume current year; if that lands today/future, assume previous year.
    function parseSessionDate(cell, todayStart){
      const raw=String(cell||"").trim();
      if(!raw) return null;

      // strip leading weekday ("Sat", "Saturday,", etc.)
      let s = raw.replace(/^(Mon|Tue|Tues|Wed|Thu|Thur|Thurs|Fri|Sat|Sun|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b,?\s*/i,"");

      // strip time portion
      s = s.replace(/\s+\d{1,2}:\d{2}(\s*[AP]M)?(\s*[A-Z]{2,5})?$/i,"").trim();

      // ISO YYYY-MM-DD (optionally with time after)
      let m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
      if(m) return new Date(+m[1], +m[2]-1, +m[3]);

      // M/D/YYYY or M-D-YYYY
      m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
      if(m) return new Date(+m[3], +m[1]-1, +m[2]);

      // M/D/YY
      m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2})$/);
      if(m){
        const yy=+m[3];
        const year = yy >= 70 ? 1900+yy : 2000+yy; // conservative
        return new Date(year, +m[1]-1, +m[2]);
      }

      // M/D (no year)
      m = s.match(/^(\d{1,2})[\/-](\d{1,2})$/);
      if(m){
        let d = new Date(todayStart.getFullYear(), +m[1]-1, +m[2]);
        if(d >= todayStart) d = new Date(todayStart.getFullYear()-1, +m[1]-1, +m[2]);
        return d;
      }

      // Month name formats (Date.parse is fine once cleaned)
      // If year missing, infer as above.
      const hasYear = /\b\d{4}\b/.test(s) || /\b\d{2}\b$/.test(s);
      const parsed = Date.parse(s);
      if(!Number.isNaN(parsed)){
        const d = new Date(parsed);
        const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        if(hasYear) return dd;

        // year missing but Date.parse guessed a year; override with inference
        let inferred = new Date(todayStart.getFullYear(), dd.getMonth(), dd.getDate());
        if(inferred >= todayStart) inferred = new Date(todayStart.getFullYear()-1, dd.getMonth(), dd.getDate());
        return inferred;
      }

      return null;
    }

    function detectDateCol(table){
      if(!table || table.length<2) return -1;
      const headers=(table[0]||[]).map(v=>String(v||"").trim());
      for(let i=0;i<headers.length;i++){
        if(/\b(date|exam\s*date|session\s*date)\b/i.test(headers[i])) return i;
      }
      const colCount=Math.max(...table.map(r=>r.length));
      const sample=table.slice(1, Math.min(table.length, 250));
      const now=new Date(); const todayStart=new Date(now.getFullYear(), now.getMonth(), now.getDate());
      let best=-1, bestScore=0;
      for(let c=0;c<colCount;c++){
        let hits=0;
        for(const r of sample){
          const v = r && r[c] != null ? r[c] : "";
          if(String(v||"").trim()==="") continue;
          if(parseSessionDate(v, todayStart)) hits++;
        }
        if(hits>bestScore){ bestScore=hits; best=c; }
      }
      return bestScore ? best : -1;
    }

    function detectCallCol(table){
      if(!table || table.length<2) return -1;
      const colCount=Math.max(...table.map(r=>r.length));
      const sample=table.slice(1, Math.min(table.length, 250));
      let best=-1, bestScore=0;
      for(let c=0;c<colCount;c++){
        let hits=0;
        for(const r of sample){
          const v = r && r[c] != null ? r[c] : "";
          if(String(v||"").trim()==="") continue;
          hits += extractCalls(v).length;
        }
        if(hits>bestScore){ bestScore=hits; best=c; }
      }
      return bestScore ? best : -1;
    }

    function computeCounts(table){
      const counts=new Map();
      if(!table || table.length<2) return { counts, completed:0, dateIdx:-1, callIdx:-1 };

      const now=new Date();
      const todayStart=new Date(now.getFullYear(), now.getMonth(), now.getDate());

      const dateIdx = detectDateCol(table);
      const callIdx = detectCallCol(table);
      if(callIdx < 0) return { counts, completed:0, dateIdx, callIdx };

      let completed=0;

      for(let r=1;r<table.length;r++){
        const row=table[r];
        if(!row || row.every(c=>String(c||"").trim()==="")) continue;

        // determine date for row (prefer detected date column; fallback: scan row)
        let d=null;
        if(dateIdx >= 0) d = parseSessionDate(row[dateIdx], todayStart);
        if(!d){
          for(let c=0;c<row.length;c++){
            d = parseSessionDate(row[c], todayStart);
            if(d) break;
          }
        }
        // Past only: strictly before today. If date can't be parsed, skip (safer than counting future).
        if(!d || d >= todayStart) continue;

        const calls = extractCalls(row[callIdx] ?? "");
        completed++;

        const uniq = new Set(calls);
        for(const cs of uniq) counts.set(cs, (counts.get(cs)||0)+1);
      }

      return { counts, completed, dateIdx, callIdx };
    }

    function updateIndicators(){
      $("ind0").textContent=""; $("ind1").textContent="";
      const a = sortDir==="asc" ? "▲" : "▼";
      if(sortCol===0) $("ind0").textContent=a;
      if(sortCol===1) $("ind1").textContent=a;
    }

    function render(){
      const sorted = rows.slice().sort((a,b)=>{
        let cmp = sortCol===0 ? a.call.localeCompare(b.call) : (a.sessions-b.sessions);
        if(cmp===0) cmp = a.call.localeCompare(b.call);
        return sortDir==="asc" ? cmp : -cmp;
      });

      rowCountEl.textContent = String(sorted.length);
      updateIndicators();

      if(!sorted.length){
        tbody.innerHTML = "<tr><td colspan=\"2\" class=\"muted\">No data.</td></tr>";
        return;
      }

      tbody.innerHTML = sorted.map(r =>
        `<tr><td class="mono">${esc(r.call)}</td><td class="center mono">${esc(r.sessions)}</td></tr>`
      ).join("");
    }

    async function fetchAndBuild(){
      setStatus("Loading…");
      tbody.innerHTML = "<tr><td colspan=\"2\" class=\"muted\">Loading…</td></tr>";
      sessionCountEl.textContent = "0";
      rowCountEl.textContent = "0";

      try{
        const url = CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "cb=" + Date.now();
        const resp = await fetch(url, { cache:"no-store" });
        if(!resp.ok) throw new Error("CSV fetch failed: HTTP " + resp.status);

        const text = await resp.text();
        const table = parseCSV(text);

        const { counts, completed, dateIdx, callIdx } = computeCounts(table);

        sessionCountEl.textContent = String(completed);
        rows = Array.from(counts.entries()).map(([call,sessions]) => ({ call, sessions }));

        // Default sort: sessions desc
        sortCol = 1; sortDir = "desc";

        const now = new Date();
        fetchedAtEl.textContent = now.toLocaleString([], { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit" });

        if(callIdx < 0){
          setStatus("Could not locate the VE call sign column in the CSV.");
          rows = [];
          render();
          return;
        }

        if(dateIdx < 0 && completed === 0){
          setStatus("Could not locate/parse a session date column, so completed sessions could not be determined.");
          rows = [];
          render();
          return;
        }

        if(!rows.length){
          setStatus("No completed sessions found to count.");
          render();
          return;
        }

        setStatus("Loaded.");
        render();
      }catch(e){
        console.error(e);
        setStatus("Could not load counts. Please try again.");
        tbody.innerHTML = "<tr><td colspan=\"2\" class=\"muted\">Error loading data.</td></tr>";
      }
    }

    document.addEventListener("click", (e) => {
      const th = e.target && e.target.closest ? e.target.closest("th[data-col]") : null;
      if(!th) return;
      const col = Number(th.getAttribute("data-col"));
      if(Number.isNaN(col)) return;
      if(sortCol===col) sortDir = (sortDir==="asc") ? "desc" : "asc";
      else { sortCol=col; sortDir = (col===1) ? "desc" : "asc"; }
      render();
    });

    refreshBtn.addEventListener("click", fetchAndBuild);
    fetchAndBuild();
  })();
  </script>
</body>
</html>
